
#include "led.h"
//ascii转键盘码（键盘数组中的偏移位置）
const u8 ascii_index[256]=
{
0,//Fn
1,//01	SOH(start of headling)	标题开始 用作默认,和分隔符
1,//02	STX (start of text)	正文开始
1,//03	ETX (end of text)	正文结束
1,//04	EOT (end of transmission)	传输结束
1,//05	ENQ (enquiry)	请求
1,//06	ACK (acknowledge)	收到通知
1,//07	BEL (bell)	响铃
1,//08	BS (backspace)	退格
43,//09	HT (horizontal tab)	水平制表符
1,//0A	LF (NL line feed, new line)	换行键
1,//0B	VT (vertical tab)	垂直制表符
1,//0C	FF (NP form feed, new page)	换页键
1,//0D	CR (carriage return)	回车键
1,//0E	SO (shift out)	不用切换
1,//0F	SI (shift in)	启用切换
1,//10	DLE (data link escape)	数据链路转义
1,//11	DC1 (device control 1)	设备控制1
1,//12	DC2 (device control 2)	设备控制2
1,//13	DC3 (device control 3)	设备控制3
1,//14	DC4 (device control 4)	设备控制4
1,//15	NAK (negative acknowledge)	拒绝接收
1,//16	SYN (synchronous idle)	同步空闲
1,//17	ETB (end of trans. block)	传输块结束
1,//18	CAN (cancel)	取消
1,//19	EM (end of medium)	介质中断
1,//1A	SUB (substitute)	替补
1,//1B	ESC (escape)	溢出
1,//1C	FS (file separator)	文件分割符
1,//1D	GS (group separator)	分组符
1,//1E	RS (record separator)	记录分离符
1,//1F	US (unit separator)	单元分隔符
44,//20	(space)	空格
1,//21	!	 
1,//22	"	 
1,//23	#	 
1,//24	$	 
1,//25	%	 
1,//26	&	 
52,//27	'	 
1,//28	(	 
1,//29	)	 
1,//2A	*	 
1,//2B	+	 
54,//2C	,	 
45,//2D	-	 
55,//2E	.	 
56,//2F	/	 
39,//30	0	 
30,//31	1	 
31,//32	2	 
32,//33	3	 
33,//34	4	 
34,//35	5	 
35,//36	6	 
36,//37	7	 
37,//38	8	 
38,//39	9	 
1,//3A	:	 
51,//3B	;	 
1,//3C	<	 
46,//3D	=	 
1,//3E	>	 
1,//3F	?	 
1,//40	@	 
101,//41	A	 用于表示APP
42,//42	B	 用于表示backspace
224,//43	C	用于表示ctrl
1,//44	D	 
1,//45	E	 
1,//46	F	 
227,//47	G	 用于表示GUI
1,//48	H	 
1,//49	I	 
1,//4A	J	 
1,//4B	K	 
226,//4C	L	用于表示LeftAlt
1,//4D	M	 
1,//4E	N	 
1,//4F	O	 
1,//50	P	 
1,//51	Q	 
230,//52	R	用于表示rightAlt
225,//53	S	用于表示shift
1,//54	T	 
1,//55	U	 
1,//56	V	 
1,//57	W	 
1,//58	X	 
1,//59	Y	 
1,//5A	Z	 
47,//5B	[	 
49,//5C	\|
48,//5D	]	 
1,//5E	^	 
1,//5F	_	 
1,//60	`	 
4,//61	a	 
5,//62	b	 
6,//63	c	 
7,//64	d	 
8,//65	e	 
9,//66	f	 
10,//67	g	 
11,//68	h	 
12,//69	i	 
13,//6A	j	 
14,//6B	k	 
15,//6C	l	 
16,//6D	m	 
17,//6E	n	 
18,//6F	o	 
19,//70	p	 
20,//71	q	 
21,//72	r	 
22,//73	s	 
23,//74	t	 
24,//75	u	 
25,//76	v	 
26,//77	w	 
27,//78	x	 
28,//79	y	 
29,//7A	z	 
1,//7B	{	 
1,//7C	|	 
1,//7D	}	 
50,//7E	~	 
1,//7F	DEL (delete)	删除
};
//数组以1为分隔符，分组,每组持续单位为10ms,1的亮度为持续时间数
S_LED_LIGHT pattern_txwgwkbp[]= //起始
{
	't',20, 1,20,'t',0, 1,2, 'x',20, 1,20,'x',0, 1,2, 'w',20, 1,20,'w',0, 1,2, 'g',20, 1,20,'g',0, 1,2, 
	'w',20, 1,20,'w',0, 1,2, 'k',20, 1,20,'k',0, 1,2, 'b',20, 1,20,'b',0, 1,2, 'p',20, 1,20,'p',0, 1,2, 1,80,
};
S_LED_LIGHT pattern_txwgwkbp1[]= //
{
	'=',20, '-',20, 1,1, '0',20, '9',20, 1,1, 'i',20, '8',20, 1,1,
	'u',20, '7',20, 1,1, '6',20, '5',20, 1,1, 'y',20, 't',20, 1,1,
	'r',20, 'e',20, 1,1, 'f',20, 'd',20, 1,1, 's',20, 'z',20, 1,100,
};
S_LED_LIGHT pattern_txwgwkbp2[]= //呼吸部分,最快
{
	'=',20,'-',20,'0',20,'9',20,'i',20,'8',20,'u',20,'7',20,'6',20,'5',20,'y',20,'t',20,'r',20,'e',20,'f',20,'d',20,'s',20,'z',20, 1,2,
	'=',19,'-',19,'0',19,'9',19,'i',19,'8',19,'u',19,'7',19,'6',19,'5',19,'y',19,'t',19,'r',19,'e',19,'f',19,'d',19,'s',19,'z',19, 1,2,
	'=',18,'-',18,'0',18,'9',18,'i',18,'8',18,'u',18,'7',18,'6',18,'5',18,'y',18,'t',18,'r',18,'e',18,'f',18,'d',18,'s',18,'z',18, 1,2,
	'=',17,'-',17,'0',17,'9',17,'i',17,'8',17,'u',17,'7',17,'6',17,'5',17,'y',17,'t',17,'r',17,'e',17,'f',17,'d',17,'s',17,'z',17, 1,2,
	'=',16,'-',16,'0',16,'9',16,'i',16,'8',16,'u',16,'7',16,'6',16,'5',16,'y',16,'t',16,'r',16,'e',16,'f',16,'d',16,'s',16,'z',16, 1,2,
	'=',15,'-',15,'0',15,'9',15,'i',15,'8',15,'u',15,'7',15,'6',15,'5',15,'y',15,'t',15,'r',15,'e',15,'f',15,'d',15,'s',15,'z',15, 1,2,
	'=',14,'-',14,'0',14,'9',14,'i',14,'8',14,'u',14,'7',14,'6',14,'5',14,'y',14,'t',14,'r',14,'e',14,'f',14,'d',14,'s',14,'z',14, 1,2,
	'=',13,'-',13,'0',13,'9',13,'i',13,'8',13,'u',13,'7',13,'6',13,'5',13,'y',13,'t',13,'r',13,'e',13,'f',13,'d',13,'s',13,'z',13, 1,2,
	'=',12,'-',12,'0',12,'9',12,'i',12,'8',12,'u',12,'7',12,'6',12,'5',12,'y',12,'t',12,'r',12,'e',12,'f',12,'d',12,'s',12,'z',12, 1,2,
	'=',11,'-',11,'0',11,'9',11,'i',11,'8',11,'u',11,'7',11,'6',11,'5',11,'y',11,'t',11,'r',11,'e',11,'f',11,'d',11,'s',11,'z',11, 1,2,
	'=',10,'-',10,'0',10,'9',10,'i',10,'8',10,'u',10,'7',10,'6',10,'5',10,'y',10,'t',10,'r',10,'e',10,'f',10,'d',10,'s',10,'z',10, 1,2,
	'=',9,'-',9,'0',9,'9',9,'i',9,'8',9,'u',9,'7',9,'6',9,'5',9,'y',9,'t',9,'r',9,'e',9,'f',9,'d',9,'s',9,'z',9, 1,2,
	'=',8,'-',8,'0',8,'9',8,'i',8,'8',8,'u',8,'7',8,'6',8,'5',8,'y',8,'t',8,'r',8,'e',8,'f',8,'d',8,'s',8,'z',8, 1,2,
	'=',7,'-',7,'0',7,'9',7,'i',7,'8',7,'u',7,'7',7,'6',7,'5',7,'y',7,'t',7,'r',7,'e',7,'f',7,'d',7,'s',7,'z',7, 1,2,
	'=',6,'-',6,'0',6,'9',6,'i',6,'8',6,'u',6,'7',6,'6',6,'5',6,'y',6,'t',6,'r',6,'e',6,'f',6,'d',6,'s',6,'z',6, 1,2,
	'=',5,'-',5,'0',5,'9',5,'i',5,'8',5,'u',5,'7',5,'6',5,'5',5,'y',5,'t',5,'r',5,'e',5,'f',5,'d',5,'s',5,'z',5, 1,2,
	'=',4,'-',4,'0',4,'9',4,'i',4,'8',4,'u',4,'7',4,'6',4,'5',4,'y',4,'t',4,'r',4,'e',4,'f',4,'d',4,'s',4,'z',4, 1,2,
	'=',3,'-',3,'0',3,'9',3,'i',3,'8',3,'u',3,'7',3,'6',3,'5',3,'y',3,'t',3,'r',3,'e',3,'f',3,'d',3,'s',3,'z',3, 1,2,
	'=',2,'-',2,'0',2,'9',2,'i',2,'8',2,'u',2,'7',2,'6',2,'5',2,'y',2,'t',2,'r',2,'e',2,'f',2,'d',2,'s',2,'z',2, 1,2,
	'=',1,'-',1,'0',1,'9',1,'i',1,'8',1,'u',1,'7',1,'6',1,'5',1,'y',1,'t',1,'r',1,'e',1,'f',1,'d',1,'s',1,'z',1, 1,2,
	'=',0,'-',0,'0',0,'9',0,'i',0,'8',0,'u',0,'7',0,'6',0,'5',0,'y',0,'t',0,'r',0,'e',0,'f',0,'d',0,'s',0,'z',0, 1,2,
	'=',1,'-',1,'0',1,'9',1,'i',1,'8',1,'u',1,'7',1,'6',1,'5',1,'y',1,'t',1,'r',1,'e',1,'f',1,'d',1,'s',1,'z',1, 1,2,
	'=',2,'-',2,'0',2,'9',2,'i',2,'8',2,'u',2,'7',2,'6',2,'5',2,'y',2,'t',2,'r',2,'e',2,'f',2,'d',2,'s',2,'z',2, 1,2,
	'=',3,'-',3,'0',3,'9',3,'i',3,'8',3,'u',3,'7',3,'6',3,'5',3,'y',3,'t',3,'r',3,'e',3,'f',3,'d',3,'s',3,'z',3, 1,2,
	'=',4,'-',4,'0',4,'9',4,'i',4,'8',4,'u',4,'7',4,'6',4,'5',4,'y',4,'t',4,'r',4,'e',4,'f',4,'d',4,'s',4,'z',4, 1,2,
	'=',5,'-',5,'0',5,'9',5,'i',5,'8',5,'u',5,'7',5,'6',5,'5',5,'y',5,'t',5,'r',5,'e',5,'f',5,'d',5,'s',5,'z',5, 1,2,
	'=',6,'-',6,'0',6,'9',6,'i',6,'8',6,'u',6,'7',6,'6',6,'5',6,'y',6,'t',6,'r',6,'e',6,'f',6,'d',6,'s',6,'z',6, 1,2,
	'=',7,'-',7,'0',7,'9',7,'i',7,'8',7,'u',7,'7',7,'6',7,'5',7,'y',7,'t',7,'r',7,'e',7,'f',7,'d',7,'s',7,'z',7, 1,2,
	'=',8,'-',8,'0',8,'9',8,'i',8,'8',8,'u',8,'7',8,'6',8,'5',8,'y',8,'t',8,'r',8,'e',8,'f',8,'d',8,'s',8,'z',8, 1,2,
	'=',9,'-',9,'0',9,'9',9,'i',9,'8',9,'u',9,'7',9,'6',9,'5',9,'y',9,'t',9,'r',9,'e',9,'f',9,'d',9,'s',9,'z',9, 1,2,
	'=',10,'-',10,'0',10,'9',10,'i',10,'8',10,'u',10,'7',10,'6',10,'5',10,'y',10,'t',10,'r',10,'e',10,'f',10,'d',10,'s',10,'z',10, 1,2,
	'=',11,'-',11,'0',11,'9',11,'i',11,'8',11,'u',11,'7',11,'6',11,'5',11,'y',11,'t',11,'r',11,'e',11,'f',11,'d',11,'s',11,'z',11, 1,2,
	'=',12,'-',12,'0',12,'9',12,'i',12,'8',12,'u',12,'7',12,'6',12,'5',12,'y',12,'t',12,'r',12,'e',12,'f',12,'d',12,'s',12,'z',12, 1,2,
	'=',13,'-',13,'0',13,'9',13,'i',13,'8',13,'u',13,'7',13,'6',13,'5',13,'y',13,'t',13,'r',13,'e',13,'f',13,'d',13,'s',13,'z',13, 1,2,
	'=',14,'-',14,'0',14,'9',14,'i',14,'8',14,'u',14,'7',14,'6',14,'5',14,'y',14,'t',14,'r',14,'e',14,'f',14,'d',14,'s',14,'z',14, 1,2,
	'=',15,'-',15,'0',15,'9',15,'i',15,'8',15,'u',15,'7',15,'6',15,'5',15,'y',15,'t',15,'r',15,'e',15,'f',15,'d',15,'s',15,'z',15, 1,2,
	'=',16,'-',16,'0',16,'9',16,'i',16,'8',16,'u',16,'7',16,'6',16,'5',16,'y',16,'t',16,'r',16,'e',16,'f',16,'d',16,'s',16,'z',16, 1,2,
	'=',17,'-',17,'0',17,'9',17,'i',17,'8',17,'u',17,'7',17,'6',17,'5',17,'y',17,'t',17,'r',17,'e',17,'f',17,'d',17,'s',17,'z',17, 1,2,
	'=',18,'-',18,'0',18,'9',18,'i',18,'8',18,'u',18,'7',18,'6',18,'5',18,'y',18,'t',18,'r',18,'e',18,'f',18,'d',18,'s',18,'z',18, 1,2,
	'=',19,'-',19,'0',19,'9',19,'i',19,'8',19,'u',19,'7',19,'6',19,'5',19,'y',19,'t',19,'r',19,'e',19,'f',19,'d',19,'s',19,'z',19, 1,2,
};
int led_stat=0; //led状态
int led_delay=0; //led延时计数器
//工具
int led_p=0; //当前执行到哪个位置了
int led_set_pattern(S_LED_LIGHT *pa,int n) //按给的pattern设置，并返回延时数
{
	for(; led_p < n; led_p++)
	{
		if (pa[led_p].key==1) //若是一个组结尾
		{
			return pa[led_p++].light;
		}
		keys[ascii_index[pa[led_p].key]].led=pa[led_p].light;
	}
	led_p=0;
	return 0;
}
////////////////////////////////////////////////////////////////////
void led_txwgwkbp(void)
{
	if (led_delay)
	{
		led_delay--;
		return ;
	}
	switch(led_stat)
	{
	case 0: //起始
		led_delay=led_set_pattern(pattern_txwgwkbp,sizeof(pattern_txwgwkbp)/sizeof(S_LED_LIGHT));
		if(led_p==0) led_stat++;
		break;
	case 1:
		led_delay=led_set_pattern(pattern_txwgwkbp1,sizeof(pattern_txwgwkbp1)/sizeof(S_LED_LIGHT));
		if(led_p==0) led_stat++;
		break;
	case 2: //呼吸
		led_delay=led_set_pattern(pattern_txwgwkbp2,sizeof(pattern_txwgwkbp2)/sizeof(S_LED_LIGHT));
		led_delay=led_delay*(1+1/(0.25+keys_per_sec_f));
		break;
	default:
		break;
	}
}
////////////////////////////////////////////////////////////////////
void (*led_fun)(void)=led_txwgwkbp;
void led_poll(void) //100Hz
{
	led_fun();
}
